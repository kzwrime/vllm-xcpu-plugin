#!/bin/bash
# Pre-commit hook: Run linter and mypy
# Fails if checks find issues, preventing the commit

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
cd "$PROJECT_ROOT"

# Get list of staged Python files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "No Python files staged, skipping checks..."
    exit 0
fi

# Run linter
echo "Running linter on staged Python files..."
if ! echo "$STAGED_FILES" | xargs ./scripts/lint.sh; then
    echo ""
    echo "=================================="
    echo "Lint failed!"
    echo "Run ./scripts/format.sh to auto-fix"
    echo "=================================="
    exit 1
fi
echo "Lint passed!"

# Run mypy
echo ""
echo "Running mypy type check..."
if ! python3 ./scripts/mypy.py; then
    echo ""
    echo "=================================="
    echo "Mypy failed!"
    echo "=================================="
    exit 1
fi
echo "Mypy passed!"
